# 第二阶段开发计划 - 互动增强

## 📋 阶段概述

**目标：** 在第一阶段基础上，增强用户与过去/未来自我的互动能力

**时间估计：** 2-3天

**前置条件：**
- ✅ 第一阶段已完成并通过测试
  - 情绪日记基础功能
  - 天气背景系统
  - 灯光开关（日夜模式）
  - 时光信箱基础功能（寄信、解锁）
  - 心情留言基础框架

---

## 🎯 核心任务

### 任务1：时光信箱完整功能 ⭐ 高优先级

#### 1.1 信件智能推荐系统

**功能描述：** 根据用户近期心情趋势，智能推荐适合的信件类型

**技术实现：**

**后端实现：**
1. 新增心情趋势分析服务
```java
// TimeCapsuleService.java
public LetterRecommendation analyzeAndRecommend(Long userId) {
    // 获取近7天心情数据
    // 分析趋势：向上/稳定/向下
    // 计算平均分
    // 返回推荐信件类型 + 理由
}
```

2. 新增推荐接口
```java
// TimeCapsuleController.java
@GetMapping("/recommend")
public Result<LetterRecommendation> getRecommendation(@RequestHeader("Authorization") String token)
```

**前端实现：**
1. 创建信件类型选择组件：`LetterTypeSelector.vue`
2. 显示推荐理由和推荐信件类型
3. 根据类型自动填充默认模板

**数据结构：**
```typescript
interface LetterRecommendation {
  recommendType: 'praise' | 'hope' | 'thanks' | 'goal'
  reason: string  // 推荐理由
  moodTrend: 'up' | 'stable' | 'down'
  avgMood: number
  template: string  // 推荐的信件模板
}
```

**预期效果：**
- 用户打开"写信给未来"时，自动显示推荐信件类型
- 清晰说明推荐理由："你最近心情不错，给自己写封表扬信吧！"

#### 1.2 信件回复与连锁对话

**功能描述：** 用户可以回复已解锁的信件，形成时间轴对话

**后端实现：**
1. 扩展TimeCapsule实体
```java
// 添加字段
private String replyChain;  // JSON数组，存储回复链
```

2. 新增回复接口
```java
@PostMapping("/reply/{id}")
public Result<TimeCapsule> replyLetter(
    @PathVariable Long id,
    @RequestBody ReplyRequest request,
    @RequestHeader("Authorization") String token
)
```

**前端实现：**
1. 在信件详情页添加"回复"按钮
2. 创建回复编辑器组件
3. 展示回复链（时间轴形式）

**预期效果：**
```
[2025-11-01] 过去的我：
"30天后的你，一定要更自信..."

[2025-12-01] 现在的我：
"谢谢当时的鼓励，我做到了！" ❤️
```

#### 1.3 信件统计与展示优化

**功能描述：** 美化信件列表，增加统计数据

**前端实现：**
1. 优化TimeCapsuleList组件
2. 添加信件卡片动画
3. 显示倒计时效果
4. 分类展示（待解锁/已解锁/已回复）

**预期效果：**
- 信件卡片带有信封图标动画
- 显示"距离解锁还有X天"倒计时
- 分类标签清晰

---

### 任务2：心情树洞 + 档案馆 ⭐ 高优先级

#### 2.1 心情树洞功能实现

**功能描述：** 用户可以对特定对象倾诉，并设置内容消失时间

**数据库设计：**
```sql
CREATE TABLE mood_tree_hole (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,

    -- 倾诉对象
    speak_to_type VARCHAR(20) COMMENT 'self-自己, person-某人, role-角色, thing-某物',
    speak_to_name VARCHAR(100) COMMENT '对象名称',

    -- 内容
    content TEXT,
    emotion_tags VARCHAR(200) COMMENT '情绪标签（JSON数组）',

    -- 时间设置
    expire_type VARCHAR(20) COMMENT '5sec, 1hour, tonight, tomorrow, forever, conditional',
    expire_time DATETIME,
    is_expired TINYINT DEFAULT 0,

    -- 查看条件（仅conditional类型）
    view_condition VARCHAR(100) COMMENT 'mood_low<3, mood_high>8, after_30days',

    -- 统计
    mood_at_write INT,
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_user (user_id),
    INDEX idx_expire (expire_time, is_expired)
);
```

**后端实现：**
1. 创建TreeHoleService和Controller
2. 添加定时任务清理过期内容
```java
@Scheduled(cron = "0 */5 * * * *")  // 每5分钟执行
public void cleanExpiredContent() {
    // 标记已过期内容
}
```

**前端实现：**
1. 创建树洞倾诉页面：`TreeHole.vue`
2. 创建倾诉编辑器组件：`TreeHoleEditor.vue`
   - 倾诉对象选择器
   - 保留时间选择器
   - 情绪标签选择
   - 倒计时效果
3. 添加到情绪日记菜单

**预期效果：**
```
对谁说：[妈妈 ▼]
保留时间：[5秒后消失 ▼]

─────────────────
对妈妈说：

[文本输入区]

#愤怒 #委屈 #想念

倒计时：[▓▓▓░░] 5秒

[说完就忘] [暂时保存]
─────────────────
```

#### 2.2 树洞档案馆

**功能描述：** 用户可以在特殊条件下查看已倾诉的内容

**后端实现：**
1. 新增档案馆接口
```java
@GetMapping("/tree-hole/archive")
public Result<ArchiveData> getArchive(
    @RequestHeader("Authorization") String token
) {
    // 根据用户当前心情状态，决定是否允许查看
    // 返回分类档案数据
}
```

2. 查看权限验证
```java
public boolean canViewArchive(Long userId) {
    // 检查用户最近3天平均心情
    // <3分 或 >8分 可查看
    return true/false;
}
```

**前端实现：**
1. 创建档案馆页面：`TreeHoleArchive.vue`
2. 分类展示倾诉内容
3. 添加验证机制（日期验证等）

**预期效果：**
```
📂 树洞档案馆

🗂️ 对自己说的话（23条）
🗂️ 对妈妈说的话（5条）
🗂️ 对前任说的话（8条）

[点击展开分类]
2025-11-01 对自己说："我真的好累..."
状态：已消失 | 当时心情：😔 3/10
```

---

### 任务3：音效系统 🎵

#### 3.1 环境音系统

**功能描述：** 根据天气类型播放对应环境音

**技术选型：** Howler.js

**前端实现：**
1. 创建音效管理服务：`soundService.ts`
```typescript
class SoundService {
  private howl: Howl | null = null

  playAmbient(weatherType: string) {
    // 根据天气类型播放环境音
  }

  stopAmbient() {
    // 停止播放
  }

  setVolume(volume: number) {
    // 设置音量
  }
}
```

2. 准备音效文件
   - rain.mp3 - 雨声
   - thunder.mp3 - 雷声
   - birds.mp3 - 鸟鸣
   - wind.mp3 - 风声
   - night.mp3 - 夜晚虫鸣

3. 集成到WeatherBackground组件

**预期效果：**
- 天气变化时自动切换环境音
- 可通过设置开关控制
- 音量可调节（0-100）

#### 3.2 交互音效

**功能描述：** 为关键操作添加音效反馈

**实现内容：**
1. 点击卡片：翻页声
2. 添加记录：写字声
3. 开关灯：开关声
4. 寄信：邮筒投递声
5. 解锁信件：拆信封声

**前端实现：**
```typescript
// 在各组件中调用
import { playSound } from '@/utils/soundService'

const handleClick = () => {
  playSound('card-flip')
  // ...其他逻辑
}
```

#### 3.3 音效设置

**功能描述：** 用户可自定义音效开关和音量

**数据库实现：**
```sql
-- 已在user_theme_settings表中
sound_enabled TINYINT DEFAULT 1,
ambient_sound_enabled TINYINT DEFAULT 1,
volume INT DEFAULT 50
```

**前端实现：**
1. 在设置页面添加音效选项
2. 同步到用户主题设置

---

### 任务4：进阶粒子动画 ✨

#### 4.1 增强天气粒子效果

**功能描述：** 为不同天气类型添加更真实的粒子效果

**技术选型：** Canvas API / Three.js（可选）

**实现内容：**
1. 🌧️ 雨滴：
   - 斜向下落
   - 速度随机
   - 落地溅起水花

2. ⛈️ 暴雨：
   - 密集雨滴
   - 闪电效果
   - 风吹效果

3. ☁️ 云朵：
   - 缓慢飘动
   - 层叠效果
   - 半透明

4. ☀️ 阳光：
   - 光线投射
   - 光斑效果
   - 温暖渐变

**前端实现：**
1. 创建粒子系统类：`ParticleSystem.ts`
2. 为每种天气创建对应粒子类
3. 优化性能（使用requestAnimationFrame）

#### 4.2 状态变化动画

**功能描述：** 为记录状态变化添加特殊粒子效果

**实现内容：**
- **已好转**：云层散开动画
- **完全度过**：彩虹桥出现
- **我战胜了它**：烟花爆炸 + 金色粒子

**前端实现：**
1. 扩展DiaryCard组件
2. 根据status触发对应动画
3. 添加动画完成回调

---

### 任务5：情绪曲线与预报 📈

#### 5.1 情绪趋势图表

**功能描述：** 可视化展示用户的心情变化趋势

**技术选型：** ECharts

**后端实现：**
1. 新增统计接口
```java
@GetMapping("/stats/mood-trend")
public Result<MoodTrendData> getMoodTrend(
    @RequestParam(defaultValue = "7") int days,
    @RequestHeader("Authorization") String token
)
```

**前端实现：**
1. 创建情绪曲线组件：`MoodTrendChart.vue`
2. 支持多时间范围：7天/30天/90天
3. 多维度显示：
   - 心情评分曲线
   - 精力水平
   - 睡眠质量
   - 压力水平

**预期效果：**
```
情绪趋势图
─────────────────────────
10│         ╭─╮
 8│       ╭╯ ╰╮
 6│     ╭╯     ╰╮
 4│   ╭╯         ╰╮
 2│ ╭╯             ╰
 0│─┴─┴─┴─┴─┴─┴─┴─
   1  3  5  7  9 11 (日期)

[7天] [30天] [90天]
```

#### 5.2 心情预报系统

**功能描述：** 基于历史数据预测未来心情趋势

**后端实现：**
1. 简单趋势预测算法
```java
public String predictMoodTrend(Long userId) {
    // 获取近14天数据
    // 计算斜率
    // 返回预测：rising/stable/declining
}
```

2. 新增预报接口
```java
@GetMapping("/weather/forecast")
public Result<MoodForecast> getForecast(@RequestHeader("Authorization") String token)
```

**前端实现：**
1. 在情绪日记顶部显示"心情预报"
2. 使用天气图标表示趋势
3. 给出建议

**预期效果：**
```
本周心情预报：☁️ → 🌤️ → ☀️

根据你最近的状态，
预计本周心情会逐渐好转 🌈
保持下去！
```

---

## 📊 任务优先级

| 优先级 | 任务 | 预计时间 | 依赖 |
|-------|------|---------|-----|
| P0 | 心情树洞基础功能 | 4h | 无 |
| P0 | 信件智能推荐 | 3h | 第一阶段时光信箱 |
| P1 | 树洞档案馆 | 3h | 心情树洞 |
| P1 | 信件回复功能 | 2h | 第一阶段时光信箱 |
| P1 | 情绪曲线图表 | 3h | 无 |
| P2 | 音效系统（环境音） | 2h | 无 |
| P2 | 进阶粒子动画 | 4h | 第一阶段天气系统 |
| P2 | 心情预报 | 2h | 情绪曲线 |
| P3 | 交互音效 | 2h | 音效系统 |

**总预计时间：** 25小时（约2-3个工作日）

---

## 🗂️ 文件结构

### 新增后端文件
```
src/main/java/com/mental/health/
├── entity/
│   └── TreeHole.java  // 树洞实体
├── mapper/
│   └── TreeHoleMapper.java
├── service/
│   ├── TreeHoleService.java
│   └── RecommendationService.java  // 推荐服务
├── controller/
│   ├── TreeHoleController.java
│   └── StatsController.java  // 统计接口
└── scheduler/
    └── TreeHoleCleanupTask.java  // 定时清理任务
```

### 新增前端文件
```
frontend/src/
├── views/patient/
│   ├── TreeHole.vue  // 心情树洞页面
│   └── TreeHoleArchive.vue  // 档案馆页面
├── components/
│   ├── TreeHole/
│   │   ├── TreeHoleEditor.vue  // 倾诉编辑器
│   │   ├── SpeakToSelector.vue  // 对象选择器
│   │   └── ExpireTimeSelector.vue  // 时间选择器
│   ├── MoodDiary/
│   │   ├── LetterTypeSelector.vue  // 信件类型选择器
│   │   ├── MoodTrendChart.vue  // 情绪曲线
│   │   └── MoodForecast.vue  // 心情预报
│   └── Particles/
│       ├── RainParticles.vue  // 雨滴粒子
│       ├── ThunderParticles.vue  // 雷电粒子
│       └── FireworksParticles.vue  // 烟花粒子
├── services/
│   ├── soundService.ts  // 音效服务
│   └── particleSystem.ts  // 粒子系统
└── utils/
    └── trendAnalyzer.ts  // 趋势分析工具
```

---

## ✅ 验收标准

### 功能完整性
- [ ] 用户可以向不同对象倾诉，并设置消失时间
- [ ] 符合条件时可查看树洞档案馆
- [ ] 信件推荐系统正常工作，推荐准确
- [ ] 用户可以回复已解锁的信件
- [ ] 情绪曲线正确展示历史数据
- [ ] 心情预报显示合理的趋势预测

### 用户体验
- [ ] 环境音随天气自动切换
- [ ] 粒子动画流畅自然
- [ ] 图表交互友好，数据清晰
- [ ] 树洞倾诉流程简洁直观
- [ ] 音效可以通过设置开关控制

### 性能要求
- [ ] 粒子动画帧率稳定（>30fps）
- [ ] 音效加载不影响页面性能
- [ ] 图表渲染流畅
- [ ] 定时任务不影响主服务性能

### 数据安全
- [ ] 树洞内容正确过期
- [ ] 档案馆权限验证有效
- [ ] 用户数据隔离

---

## 🚀 开发流程建议

### Day 1（8小时）
**上午（4h）：**
1. 创建树洞数据表和实体类
2. 实现TreeHoleService基础CRUD
3. 添加TreeHoleController接口

**下午（4h）：**
1. 实现TreeHoleEditor组件
2. 集成倾诉对象和时间选择器
3. 测试基础倾诉功能

### Day 2（8小时）
**上午（4h）：**
1. 实现定时清理任务
2. 实现档案馆后端接口
3. 实现权限验证逻辑

**下午（4h）：**
1. 创建TreeHoleArchive页面
2. 实现分类展示功能
3. 添加验证机制
4. 完成信件智能推荐系统

### Day 3（8小时）
**上午（4h）：**
1. 集成Howler.js音效系统
2. 添加环境音文件
3. 实现音效自动切换
4. 添加音效设置

**下午（4h）：**
1. 实现情绪曲线图表
2. 实现心情预报
3. 优化粒子动画效果
4. 综合测试所有新功能

---

## 📝 测试计划

### 单元测试
- TreeHoleService测试
- RecommendationService测试
- 定时任务测试

### 集成测试
- 树洞倾诉完整流程
- 档案馆查看权限
- 信件推荐准确性
- 音效切换逻辑

### 用户体验测试
- 倾诉流程是否流畅
- 推荐信件是否合理
- 音效是否合适
- 图表是否清晰
- 粒子动画是否流畅

---

## 🎯 第二阶段完成标准

当以下所有条件满足时，第二阶段视为完成：

1. ✅ 所有P0、P1任务完成并测试通过
2. ✅ 至少完成60%的P2任务
3. ✅ 所有新增功能通过用户验收测试
4. ✅ 无严重Bug或性能问题
5. ✅ 代码已提交并文档已更新

---

## 📌 注意事项

1. **音效文件准备：** 提前准备好各类音效文件，确保格式兼容
2. **性能监控：** 粒子动画和音效可能影响性能，需持续监控
3. **用户隐私：** 树洞内容要妥善处理，确保过期后真正删除
4. **推荐准确性：** 信件推荐算法需要多次调试优化
5. **音效音量：** 默认音量不宜过大，避免打扰用户

---

**准备好开始第二阶段开发了吗？**

建议从最高优先级（P0）任务开始，逐步推进！
