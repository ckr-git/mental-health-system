# 情绪日记 - 第一阶段开发计划

## 📋 开发目标

**时间**：1周（7天）
**核心体验**：温馨的心灵港湾 MVP

---

## 🎯 第一阶段核心功能

### 1. ✅ 天气主题系统
- 5种心情-天气映射
- 2D粒子效果（简化版）
- 背景渐变色切换
- 天气图标和动画

### 2. ✅ 灯光开关
- 日夜双模式切换
- 灯绳拉动动画
- 整体色调切换
- 开关音效

### 3. ✅ 心情留言
- 留言板对话气泡
- 5种互动类型（赞同/不认同/心疼/鼓励/释然）
- 时间轴展示
- 留言统计

### 4. ✅ 时光信箱
- 3种基础信件类型（表扬/期望/感谢）
- 写信界面
- 信箱列表
- 倒计时显示
- 解锁阅读

---

## 🗄️ 数据库设计（第一阶段精简版）

### 1. 症状记录表（重构）

```sql
-- 备份旧表
RENAME TABLE symptom_record TO symptom_record_backup;

-- 创建新的情绪日记表
CREATE TABLE mood_diary (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL COMMENT '用户ID',
    
    -- 基础信息
    mood_score INT NOT NULL COMMENT '心情评分 1-10',
    mood_emoji VARCHAR(10) COMMENT '心情表情',
    title VARCHAR(100) COMMENT '标题（一句话）',
    content TEXT COMMENT '详细内容',
    
    -- 多维度评分
    energy_level INT COMMENT '精力水平 1-10',
    sleep_quality INT COMMENT '睡眠质量 1-10',
    stress_level INT COMMENT '压力水平 1-10',
    
    -- 天气主题
    weather_type VARCHAR(20) COMMENT '天气类型：storm, rain, cloudy, sunny, clear',
    weather_config JSON COMMENT '天气配置（颜色、粒子参数）',
    
    -- 状态标记
    status VARCHAR(20) DEFAULT 'ongoing' COMMENT '状态：ongoing-正在经历, better-已好转, overcome-已度过, proud-我战胜了它',
    status_update_time DATETIME COMMENT '状态更新时间',
    
    -- 统计数据
    view_count INT DEFAULT 0 COMMENT '回看次数',
    comment_count INT DEFAULT 0 COMMENT '留言数',
    interaction_count JSON COMMENT '互动统计 {agree:3, heartache:5...}',
    
    -- 时间
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_user_time (user_id, create_time),
    INDEX idx_user_status (user_id, status)
) ENGINE=InnoDB COMMENT='情绪日记表';
```

### 2. 心情留言表

```sql
CREATE TABLE mood_comment (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    diary_id BIGINT NOT NULL COMMENT '日记ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    
    -- 留言内容
    content TEXT NOT NULL COMMENT '留言内容',
    comment_type VARCHAR(20) DEFAULT 'random' COMMENT '类型：random-随便说说, praise-点赞, hug-抱抱, note-想说, thought-现在想法',
    
    -- 互动标记（多选，JSON数组）
    interactions JSON COMMENT '互动类型 ["agree", "heartache", "encourage"]',
    
    -- 情绪对比
    mood_at_comment INT COMMENT '留言时的心情',
    mood_at_diary INT COMMENT '日记时的心情',
    mood_gap INT COMMENT '心情差值（自动计算）',
    
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_diary (diary_id),
    INDEX idx_user (user_id)
) ENGINE=InnoDB COMMENT='心情留言表';
```

### 3. 时光信箱表

```sql
CREATE TABLE time_capsule (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    
    -- 信件信息
    letter_type VARCHAR(30) NOT NULL COMMENT '信件类型：praise-表扬信, hope-期望信, thanks-感谢信',
    title VARCHAR(100) COMMENT '信件标题',
    content TEXT NOT NULL COMMENT '信件内容',
    
    -- 触发数据
    trigger_mood_avg DECIMAL(3,1) COMMENT '触发时平均心情',
    trigger_mood_trend VARCHAR(20) COMMENT '触发趋势：up-上升, stable-平稳, down-下降',
    related_diary_ids JSON COMMENT '关联日记ID列表',
    
    -- 时间控制
    write_date DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '写信时间',
    unlock_date DATE NOT NULL COMMENT '解锁日期',
    unlock_days INT COMMENT '解锁天数（方便查询）',
    
    -- 状态
    status VARCHAR(20) DEFAULT 'sealed' COMMENT '状态：sealed-封存, unlocked-已解锁, read-已读, replied-已回复',
    unlock_time DATETIME COMMENT '解锁时间',
    read_time DATETIME COMMENT '阅读时间',
    reply_content TEXT COMMENT '回复内容',
    reply_time DATETIME COMMENT '回复时间',
    
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_user (user_id),
    INDEX idx_unlock_date (unlock_date, status),
    INDEX idx_status (status)
) ENGINE=InnoDB COMMENT='时光信箱表';
```

### 4. 用户主题设置表

```sql
CREATE TABLE user_theme_config (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL UNIQUE,
    
    -- 灯光模式
    light_mode VARCHAR(10) DEFAULT 'day' COMMENT '灯光模式：day-白天, night-夜晚',
    
    -- 天气效果开关
    weather_enabled TINYINT DEFAULT 1 COMMENT '天气效果开关',
    particle_enabled TINYINT DEFAULT 1 COMMENT '粒子效果开关',
    animation_enabled TINYINT DEFAULT 1 COMMENT '动画效果开关',
    
    -- 音效开关
    sound_enabled TINYINT DEFAULT 1 COMMENT '音效开关',
    volume INT DEFAULT 50 COMMENT '音量 0-100',
    
    -- 统计数据
    light_toggle_count INT DEFAULT 0 COMMENT '开关灯次数',
    total_diary_count INT DEFAULT 0 COMMENT '总日记数',
    total_comment_count INT DEFAULT 0 COMMENT '总留言数',
    total_letter_count INT DEFAULT 0 COMMENT '总信件数',
    
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_user (user_id)
) ENGINE=InnoDB COMMENT='用户主题配置表';
```

### 5. 天气主题配置表（系统表）

```sql
CREATE TABLE weather_config (
    id INT PRIMARY KEY AUTO_INCREMENT,
    weather_type VARCHAR(20) UNIQUE COMMENT '天气类型',
    weather_name VARCHAR(50) COMMENT '天气名称',
    
    -- 心情范围
    mood_min INT COMMENT '心情最小值',
    mood_max INT COMMENT '心情最大值',
    
    -- 视觉配置
    bg_gradient_start VARCHAR(10) COMMENT '背景渐变起始色',
    bg_gradient_end VARCHAR(10) COMMENT '背景渐变结束色',
    weather_icon VARCHAR(20) COMMENT '天气图标',
    
    -- 粒子配置
    particle_type VARCHAR(30) COMMENT '粒子类型：rain, snow, cloud, sunshine',
    particle_color VARCHAR(10) COMMENT '粒子颜色',
    particle_count INT DEFAULT 50 COMMENT '粒子数量',
    particle_speed DECIMAL(3,2) DEFAULT 1.0 COMMENT '粒子速度',
    
    -- 音效
    ambient_sound VARCHAR(100) COMMENT '环境音文件名',
    
    -- 描述
    description VARCHAR(200) COMMENT '天气描述'
) ENGINE=InnoDB COMMENT='天气主题配置表';

-- 插入初始数据
INSERT INTO weather_config (weather_type, weather_name, mood_min, mood_max, bg_gradient_start, bg_gradient_end, weather_icon, particle_type, particle_color, ambient_sound, description) VALUES
('storm', '暴风雨', 1, 2, '#1a1a2e', '#16213e', '🌩️', 'rain', '#6B8CAE', 'storm.mp3', '心情很差，像暴风雨一样'),
('rain', '阴雨', 3, 4, '#4A5FC7', '#6B7FD7', '🌧️', 'rain', '#8BA4D9', 'rain.mp3', '有些低落，阴雨绵绵'),
('cloudy', '多云', 5, 6, '#8BA4D9', '#B8C5E0', '☁️', 'cloud', '#D4DCF0', 'wind.mp3', '平和的心情，多云'),
('sunny', '晴朗', 7, 8, '#FFD700', '#FFA500', '🌤️', 'sunshine', '#FFEB99', 'birds.mp3', '心情不错，阳光明媚'),
('clear', '晴空', 9, 10, '#87CEEB', '#00BFFF', '☀️', 'sunshine', '#FFEB3B', 'happy.mp3', '心情极好，万里晴空');
```

---

## 🏗️ 技术架构

### 后端（Spring Boot）

#### 新增接口

```java
// 1. 情绪日记接口
@RestController
@RequestMapping("/api/patient/mood-diary")
public class MoodDiaryController {
    
    // 添加日记
    POST /add
    
    // 获取日记列表（分页）
    GET /list
    
    // 获取日记详情
    GET /detail/{id}
    
    // 更新状态
    PUT /status/{id}
    
    // 获取统计数据
    GET /stats
}

// 2. 心情留言接口
@RestController
@RequestMapping("/api/patient/mood-comment")
public class MoodCommentController {
    
    // 添加留言
    POST /add
    
    // 获取日记的留言列表
    GET /list/{diaryId}
    
    // 更新互动
    PUT /interaction/{commentId}
}

// 3. 时光信箱接口
@RestController
@RequestMapping("/api/patient/time-capsule")
public class TimeCapsuleController {
    
    // 写信
    POST /write
    
    // 获取信箱列表
    GET /list
    
    // 解锁信件
    GET /unlock/{id}
    
    // 阅读信件
    POST /read/{id}
    
    // 回复信件
    POST /reply/{id}
    
    // 检查可解锁的信件（定时任务调用）
    GET /check-unlock
}

// 4. 主题配置接口
@RestController
@RequestMapping("/api/patient/theme")
public class ThemeController {
    
    // 获取当前主题配置
    GET /config
    
    // 切换灯光模式
    POST /toggle-light
    
    // 更新设置
    PUT /settings
    
    // 获取天气配置
    GET /weather
}
```

### 前端（Vue 3）

#### 目录结构

```
frontend/src/
├── views/
│   └── patient/
│       └── MoodDiary.vue          # 主页面
├── components/
│   └── mood-diary/
│       ├── WeatherSystem.vue      # 天气系统组件
│       ├── LightSwitch.vue        # 灯光开关组件
│       ├── DiaryCard.vue          # 日记卡片组件
│       ├── CommentDialog.vue      # 留言对话框
│       ├── LetterEditor.vue       # 写信编辑器
│       └── LetterBox.vue          # 信箱组件
├── composables/
│   ├── useWeather.ts              # 天气系统逻辑
│   ├── useParticles.ts            # 粒子效果
│   ├── useLightMode.ts            # 灯光模式
│   └── useSound.ts                # 音效管理
├── utils/
│   ├── weatherConfig.ts           # 天气配置
│   └── particleEngine.ts          # 粒子引擎（简化版）
└── assets/
    ├── sounds/                     # 音效文件
    └── images/                     # 图片资源
```

#### 核心技术栈

**动画与效果**：
- CSS3 Transitions/Animations（基础动画）
- Canvas API（粒子系统 - 2D简化版）
- GSAP（复杂动画，如灯光切换）

**音效**：
- Howler.js（音频管理）

**状态管理**：
- Pinia（全局状态）
- VueUse（工具函数）

---

## 📅 7天开发时间表

### Day 1-2：数据库 + 后端接口

**Day 1 上午**：
- ✅ 创建新数据库表
- ✅ 编写Entity实体类
- ✅ 编写Mapper接口

**Day 1 下午**：
- ✅ MoodDiaryService 实现
- ✅ MoodCommentService 实现
- ✅ MoodDiaryController 实现
- ✅ MoodCommentController 实现

**Day 2 上午**：
- ✅ TimeCapsuleService 实现
- ✅ ThemeService 实现
- ✅ TimeCapsuleController 实现
- ✅ ThemeController 实现

**Day 2 下午**：
- ✅ 后端接口测试
- ✅ 定时任务（检查解锁信件）
- ✅ 接口文档整理

### Day 3-4：前端基础框架

**Day 3 上午**：
- ✅ 创建目录结构
- ✅ 配置路由
- ✅ 创建基础组件框架
- ✅ 设置Pinia Store

**Day 3 下午**：
- ✅ WeatherSystem 组件（静态）
- ✅ 天气配置和映射逻辑
- ✅ 背景渐变色切换

**Day 4 上午**：
- ✅ LightSwitch 组件
- ✅ 灯绳动画（CSS + GSAP）
- ✅ 日夜模式切换逻辑

**Day 4 下午**：
- ✅ DiaryCard 组件
- ✅ 卡片布局和样式
- ✅ 状态标记UI

### Day 5：核心功能实现

**Day 5 上午**：
- ✅ 粒子系统（Canvas - 简化版）
- ✅ 5种天气的粒子效果
- ✅ 性能优化（requestAnimationFrame）

**Day 5 下午**：
- ✅ CommentDialog 组件
- ✅ 留言气泡UI
- ✅ 互动按钮（赞同/心疼等）
- ✅ 时间轴布局

### Day 6：时光信箱

**Day 6 上午**：
- ✅ LetterEditor 组件
- ✅ 3种信件模板
- ✅ 写信界面UI

**Day 6 下午**：
- ✅ LetterBox 组件
- ✅ 信箱列表展示
- ✅ 倒计时逻辑
- ✅ 解锁动画

### Day 7：联调测试与优化

**Day 7 上午**：
- ✅ 前后端联调
- ✅ 音效添加
- ✅ 功能测试

**Day 7 下午**：
- ✅ Bug修复
- ✅ 性能优化
- ✅ 细节打磨
- ✅ 用户体验测试

---

## 🎨 UI设计要点（第一阶段）

### 配色方案

#### 白天模式（开灯 💡）
```
主背景：#F5F7FA（浅灰白）
卡片背景：#FFFFFF
文字主色：#303133
文字次色：#606266
强调色：#409EFF
温暖色：#FFA500
```

#### 夜晚模式（关灯 🌙）
```
主背景：#1A1A2E（深蓝）
卡片背景：#16213E
文字主色：#E0E0E0
文字次色：#B0B0B0
强调色：#67C23A
月光色：#8BA4D9
```

#### 天气配色（覆盖背景）
```
暴风雨：#1a1a2e → #16213e
阴雨：#4A5FC7 → #6B7FD7
多云：#8BA4D9 → #B8C5E0
晴朗：#FFD700 → #FFA500
晴空：#87CEEB → #00BFFF
```

### 关键动画

#### 1. 灯光切换（GSAP）
```javascript
// 开灯
gsap.to('.background', {
  backgroundColor: '#F5F7FA',
  duration: 0.8,
  ease: 'power2.inOut'
})

// 关灯
gsap.to('.background', {
  backgroundColor: '#1A1A2E',
  duration: 0.8,
  ease: 'power2.inOut'
})
```

#### 2. 卡片加载
```css
@keyframes slideInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.diary-card {
  animation: slideInUp 0.5s ease-out;
}
```

#### 3. 天气切换
```javascript
// 天气渐变切换
const changeWeather = (fromWeather, toWeather) => {
  gsap.to('.weather-bg', {
    background: `linear-gradient(${toWeather.startColor}, ${toWeather.endColor})`,
    duration: 1.5,
    ease: 'power1.inOut'
  })
  
  // 粒子系统切换
  switchParticles(fromWeather.type, toWeather.type)
}
```

---

## 🧪 测试计划

### 功能测试清单

#### 情绪日记
- [ ] 添加日记（不同心情分数）
- [ ] 日记列表加载
- [ ] 日记详情查看
- [ ] 状态标记切换
- [ ] 天气自动匹配
- [ ] 回看次数统计

#### 心情留言
- [ ] 添加留言
- [ ] 留言列表展示
- [ ] 互动按钮（5种）
- [ ] 时间轴排序
- [ ] 留言数统计

#### 时光信箱
- [ ] 写信（3种类型）
- [ ] 信箱列表
- [ ] 倒计时显示
- [ ] 解锁逻辑（到期）
- [ ] 阅读信件
- [ ] 回复信件

#### 天气主题
- [ ] 天气自动匹配（5种）
- [ ] 背景渐变切换
- [ ] 粒子效果（5种）
- [ ] 性能测试（60fps）
- [ ] 移动端适配

#### 灯光开关
- [ ] 灯绳拉动动画
- [ ] 日夜模式切换
- [ ] 整体色调变化
- [ ] 音效播放
- [ ] 状态持久化

### 性能指标

- **首屏加载**：< 2秒
- **动画帧率**：60fps
- **粒子数量**：50-100个（可调节）
- **内存占用**：< 100MB
- **移动端流畅度**：良好

---

## 🚀 开发启动命令

### 后端
```bash
cd "E:\ddd\智能心里健康管理系统"
mvn spring-boot:run
```

### 前端
```bash
cd frontend
npm run dev
```

### 数据库
```bash
# 执行数据库脚本
mysql -u root -p mental_health < phase1-database.sql
```

---

## 📝 注意事项

### 1. 数据策略
- ✅ 创建新表，不影响旧数据
- ✅ 旧表重命名为 `symptom_record_backup`
- ✅ 用户可以选择是否迁移旧数据（后期功能）

### 2. 性能优化
- ✅ 粒子系统使用对象池
- ✅ 使用 requestAnimationFrame
- ✅ 懒加载历史记录
- ✅ 图片懒加载
- ✅ 防抖节流

### 3. 兼容性
- ✅ 支持Chrome/Edge/Firefox最新版
- ✅ 移动端Safari
- ✅ 响应式设计（PC + Mobile）

### 4. 可访问性
- ✅ 键盘导航支持
- ✅ 音效可关闭
- ✅ 粒子效果可关闭（低性能设备）
- ✅ 高对比度模式（后期）

---

## ✅ 验收标准

### 完成标准
- [ ] 所有4个核心功能可用
- [ ] 天气系统流畅运行
- [ ] 灯光开关动画流畅
- [ ] 心情留言正常交互
- [ ] 时光信箱完整流程
- [ ] 移动端适配良好
- [ ] 无重大Bug
- [ ] 性能达标

### 体验标准
- [ ] "哇，这不一样！"的第一印象
- [ ] 温馨的"家"的感觉
- [ ] 流畅的动画体验
- [ ] 沉浸式天气氛围
- [ ] 情感宣泄通道畅通

---

**准备好了吗？开始第一阶段开发！** 🚀
