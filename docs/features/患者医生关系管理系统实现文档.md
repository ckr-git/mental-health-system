# æ‚£è€…-åŒ»ç”Ÿå…³ç³»ç®¡ç†ç³»ç»Ÿå®ç°æ–‡æ¡£

## ğŸ“‹ ç³»ç»Ÿæ¦‚è¿°

æœ¬ç³»ç»Ÿå®ç°äº†æ™ºèƒ½å¿ƒç†å¥åº·ç®¡ç†å¹³å°çš„æ‚£è€…-åŒ»ç”Ÿå…³ç³»ç®¡ç†åŠŸèƒ½ï¼ŒåŒ…æ‹¬æ‚£è€…å…¬æµ·ã€åŒ»ç”Ÿè®¤é¢†/é‡Šæ”¾æ‚£è€…ã€ç®¡ç†å‘˜å®¡æ ¸ã€åœ¨çº¿å’¨è¯¢ç­‰å®Œæ•´çš„åŒ»æ‚£ç®¡ç†æµç¨‹ã€‚

### æ ¸å¿ƒç‰¹æ€§

- **æ‚£è€…å…¬æµ·æœºåˆ¶**ï¼šæœªåˆ†é…çš„æ‚£è€…è¿›å…¥å…¬æµ·ï¼ŒåŒ»ç”Ÿå¯ä¸»åŠ¨è®¤é¢†
- **å®¡æ‰¹å·¥ä½œæµ**ï¼šæ‰€æœ‰è®¤é¢†/é‡Šæ”¾æ“ä½œéœ€ç®¡ç†å‘˜å®¡æ ¸
- **å…³ç³»çº¦æŸ**ï¼šä¸€ä¸ªåŒ»ç”Ÿæœ€å¤šç®¡ç†10ä¸ªæ‚£è€…ï¼Œä¸€ä¸ªæ‚£è€…åªèƒ½åˆ†é…ç»™1ä¸ªåŒ»ç”Ÿ
- **åœ¨çº¿å’¨è¯¢**ï¼šåŒ»ç”Ÿå¯ç®¡ç†ä¸æ‚£è€…çš„å’¨è¯¢ä¼šè¯
- **ä¸‰ç«¯ååŒ**ï¼šåŒ»ç”Ÿç«¯ã€ç®¡ç†å‘˜ç«¯ã€æ‚£è€…ç«¯åŠŸèƒ½æ¸…æ™°åˆ†ç¦»

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### åç«¯æŠ€æœ¯æ ˆ
- **æ¡†æ¶**ï¼šSpring Boot 3.2.0
- **ORM**ï¼šMyBatis-Plus 3.5.5
- **æ•°æ®åº“**ï¼šMySQL 8.0
- **å®‰å…¨**ï¼šSpring Security + JWT
- **è¯­è¨€**ï¼šJava 17

### å‰ç«¯æŠ€æœ¯æ ˆ
- **æ¡†æ¶**ï¼šVue 3 Composition API
- **è¯­è¨€**ï¼šTypeScript
- **UIç»„ä»¶**ï¼šElement Plus
- **çŠ¶æ€ç®¡ç†**ï¼šPinia
- **æ„å»ºå·¥å…·**ï¼šVite

---

## ğŸ’¾ æ•°æ®åº“è®¾è®¡

### 1. åŒ»æ‚£å…³ç³»è¡¨ (patient_doctor_relationship)

å­˜å‚¨æ´»è·ƒçš„åŒ»æ‚£å…³ç³»ã€‚

```sql
CREATE TABLE IF NOT EXISTS patient_doctor_relationship (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
    patient_id BIGINT NOT NULL COMMENT 'æ‚£è€…ID',
    doctor_id BIGINT NOT NULL COMMENT 'åŒ»ç”ŸID',
    relationship_status VARCHAR(20) DEFAULT 'active' COMMENT 'å…³ç³»çŠ¶æ€: active-æ´»è·ƒ, inactive-å·²é‡Šæ”¾',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    deleted TINYINT DEFAULT 0 COMMENT 'é€»è¾‘åˆ é™¤æ ‡å¿—',
    UNIQUE KEY uk_patient_active (patient_id, deleted, relationship_status) COMMENT 'ç¡®ä¿ä¸€ä¸ªæ‚£è€…åªèƒ½æœ‰ä¸€ä¸ªæ´»è·ƒåŒ»ç”Ÿ'
) COMMENT='åŒ»æ‚£å…³ç³»è¡¨';
```

**å…³é”®å­—æ®µ**ï¼š
- `patient_id`ï¼šæ‚£è€…ç”¨æˆ·ID
- `doctor_id`ï¼šåŒ»ç”Ÿç”¨æˆ·ID
- `relationship_status`ï¼šå…³ç³»çŠ¶æ€ï¼ˆactive/inactiveï¼‰
- `uk_patient_active`ï¼šå”¯ä¸€ç´¢å¼•ï¼Œç¡®ä¿ä¸€ä¸ªæ‚£è€…åªèƒ½æœ‰ä¸€ä¸ªæ´»è·ƒåŒ»ç”Ÿ

### 2. æ‚£è€…åˆ†é…å˜æ›´è¯·æ±‚è¡¨ (relationship_change_request)

å­˜å‚¨åŒ»ç”Ÿè®¤é¢†/é‡Šæ”¾æ‚£è€…çš„å®¡æ‰¹è¯·æ±‚ã€‚

```sql
CREATE TABLE IF NOT EXISTS relationship_change_request (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
    patient_id BIGINT NOT NULL COMMENT 'æ‚£è€…ID',
    doctor_id BIGINT NOT NULL COMMENT 'åŒ»ç”ŸID',
    operation_type VARCHAR(20) NOT NULL COMMENT 'æ“ä½œç±»å‹: claim-è®¤é¢†, release-é‡Šæ”¾',
    request_status VARCHAR(20) DEFAULT 'pending' COMMENT 'è¯·æ±‚çŠ¶æ€: pending-å¾…å®¡æ ¸, approved-é€šè¿‡, rejected-æ‹’ç»',
    request_reason TEXT COMMENT 'ç”³è¯·ç†ç”±',
    admin_id BIGINT COMMENT 'å®¡æ ¸ç®¡ç†å‘˜ID',
    admin_note TEXT COMMENT 'ç®¡ç†å‘˜å®¡æ ¸å¤‡æ³¨',
    approval_time DATETIME COMMENT 'å®¡æ ¸æ—¶é—´',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    deleted TINYINT DEFAULT 0 COMMENT 'é€»è¾‘åˆ é™¤æ ‡å¿—'
) COMMENT='æ‚£è€…åˆ†é…å˜æ›´è¯·æ±‚è¡¨';
```

**å…³é”®å­—æ®µ**ï¼š
- `operation_type`ï¼šæ“ä½œç±»å‹ï¼ˆclaim-è®¤é¢† / release-é‡Šæ”¾ï¼‰
- `request_status`ï¼šå®¡æ ¸çŠ¶æ€ï¼ˆpending-å¾…å®¡æ ¸ / approved-é€šè¿‡ / rejected-æ‹’ç»ï¼‰
- `request_reason`ï¼šåŒ»ç”Ÿç”³è¯·ç†ç”±
- `admin_note`ï¼šç®¡ç†å‘˜å®¡æ ¸å¤‡æ³¨

### 3. åœ¨çº¿å’¨è¯¢ä¼šè¯è¡¨ (consultation_session)

å­˜å‚¨åŒ»ç”Ÿä¸æ‚£è€…çš„å’¨è¯¢ä¼šè¯è®°å½•ã€‚

```sql
CREATE TABLE IF NOT EXISTS consultation_session (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
    patient_id BIGINT NOT NULL COMMENT 'æ‚£è€…ID',
    doctor_id BIGINT NOT NULL COMMENT 'åŒ»ç”ŸID',
    session_status VARCHAR(20) DEFAULT 'ongoing' COMMENT 'ä¼šè¯çŠ¶æ€: ongoing-è¿›è¡Œä¸­, closed-å·²å…³é—­',
    start_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'å¼€å§‹æ—¶é—´',
    end_time DATETIME COMMENT 'ç»“æŸæ—¶é—´',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    deleted TINYINT DEFAULT 0 COMMENT 'é€»è¾‘åˆ é™¤æ ‡å¿—'
) COMMENT='åœ¨çº¿å’¨è¯¢ä¼šè¯è¡¨';
```

**å…³é”®å­—æ®µ**ï¼š
- `session_status`ï¼šä¼šè¯çŠ¶æ€ï¼ˆongoing-è¿›è¡Œä¸­ / closed-å·²å…³é—­ï¼‰
- `start_time`ï¼šä¼šè¯å¼€å§‹æ—¶é—´
- `end_time`ï¼šä¼šè¯ç»“æŸæ—¶é—´

---

## ğŸ”§ åç«¯å®ç°

### 1. Entityå±‚

#### PatientDoctorRelationship.java
```java
@Data
@TableName("patient_doctor_relationship")
public class PatientDoctorRelationship {
    @TableId(type = IdType.AUTO)
    private Long id;
    private Long patientId;
    private Long doctorId;
    private String relationshipStatus; // active, inactive
    private LocalDateTime createTime;
    private LocalDateTime updateTime;
    @TableLogic
    private Integer deleted;
}
```

#### RelationshipChangeRequest.java
```java
@Data
@TableName("relationship_change_request")
public class RelationshipChangeRequest {
    @TableId(type = IdType.AUTO)
    private Long id;
    private Long patientId;
    private Long doctorId;
    private String operationType; // claim, release
    private String requestStatus; // pending, approved, rejected
    private String requestReason;
    private Long adminId;
    private String adminNote;
    private LocalDateTime approvalTime;
    private LocalDateTime createTime;
    private LocalDateTime updateTime;
    @TableLogic
    private Integer deleted;
}
```

#### ConsultationSession.java
```java
@Data
@TableName("consultation_session")
public class ConsultationSession {
    @TableId(type = IdType.AUTO)
    private Long id;
    private Long patientId;
    private Long doctorId;
    private String sessionStatus; // ongoing, closed
    private LocalDateTime startTime;
    private LocalDateTime endTime;
    private LocalDateTime createTime;
    private LocalDateTime updateTime;
    @TableLogic
    private Integer deleted;
}
```

### 2. Mapperå±‚

ä½¿ç”¨ MyBatis-Plus çš„ `BaseMapper` æ¥å£ï¼Œæä¾›åŸºç¡€çš„ CRUD æ“ä½œã€‚

```java
@Mapper
public interface PatientDoctorRelationshipMapper extends BaseMapper<PatientDoctorRelationship> {}

@Mapper
public interface RelationshipChangeRequestMapper extends BaseMapper<RelationshipChangeRequest> {}

@Mapper
public interface ConsultationSessionMapper extends BaseMapper<ConsultationSession> {}
```

### 3. Serviceå±‚

#### PatientDoctorRelationshipService

**æ ¸å¿ƒæ–¹æ³•**ï¼š

| æ–¹æ³• | åŠŸèƒ½ | è¯´æ˜ |
|-----|------|------|
| `checkDoctorPatientLimit` | æ£€æŸ¥åŒ»ç”Ÿæ‚£è€…æ•°é‡é™åˆ¶ | éªŒè¯åŒ»ç”Ÿæ˜¯å¦å·²è¾¾åˆ°10äººä¸Šé™ |
| `getPatientDoctor` | è·å–æ‚£è€…çš„åˆ†é…åŒ»ç”Ÿ | è¿”å›æ‚£è€…å½“å‰åˆ†é…çš„åŒ»ç”Ÿä¿¡æ¯ |
| `getDoctorPatients` | è·å–åŒ»ç”Ÿçš„æ‚£è€…åˆ—è¡¨ | è¿”å›åŒ»ç”Ÿç®¡ç†çš„æ‰€æœ‰æ‚£è€… |
| `createRelationship` | åˆ›å»ºåŒ»æ‚£å…³ç³» | å»ºç«‹æ–°çš„åŒ»æ‚£å…³ç³»ï¼Œå¸¦éªŒè¯ |
| `removeRelationship` | ç§»é™¤åŒ»æ‚£å…³ç³» | å°†å…³ç³»çŠ¶æ€è®¾ä¸ºinactive |

**å…³é”®ä¸šåŠ¡é€»è¾‘**ï¼š
```java
public void checkDoctorPatientLimit(Long doctorId) {
    QueryWrapper<PatientDoctorRelationship> wrapper = new QueryWrapper<>();
    wrapper.eq("doctor_id", doctorId)
           .eq("relationship_status", "active")
           .eq("deleted", 0);
    long count = relationshipMapper.selectCount(wrapper);
    if (count >= 10) {
        throw new RuntimeException("è¯¥åŒ»ç”Ÿå·²è¾¾åˆ°æœ€å¤§æ‚£è€…æ•°é‡é™åˆ¶(10äºº)");
    }
}
```

#### RelationshipChangeRequestService

**æ ¸å¿ƒæ–¹æ³•**ï¼š

| æ–¹æ³• | åŠŸèƒ½ | è¯´æ˜ |
|-----|------|------|
| `submitClaimRequest` | æäº¤è®¤é¢†ç”³è¯· | éªŒè¯åŒ»ç”Ÿé™é¢å’Œæ‚£è€…çŠ¶æ€ååˆ›å»ºç”³è¯· |
| `submitReleaseRequest` | æäº¤é‡Šæ”¾ç”³è¯· | éªŒè¯å…³ç³»å­˜åœ¨ååˆ›å»ºç”³è¯· |
| `getPendingRequests` | è·å–å¾…å®¡æ ¸è¯·æ±‚ | åˆ†é¡µè¿”å›å¾…å®¡æ ¸çš„ç”³è¯·åˆ—è¡¨ |
| `approveRequest` | å®¡æ ¸é€šè¿‡ | æ›´æ–°çŠ¶æ€å¹¶æ‰§è¡Œå®é™…çš„å…³ç³»å˜æ›´ |
| `rejectRequest` | å®¡æ ¸æ‹’ç» | æ›´æ–°çŠ¶æ€å¹¶è®°å½•æ‹’ç»ç†ç”± |

**å®¡æ‰¹æµç¨‹**ï¼š
```java
@Transactional
public void approveRequest(Long requestId, Long adminId, String adminNote) {
    // 1. æ›´æ–°è¯·æ±‚çŠ¶æ€
    request.setRequestStatus("approved");
    request.setAdminId(adminId);
    request.setAdminNote(adminNote);
    request.setApprovalTime(LocalDateTime.now());

    // 2. æ‰§è¡Œå®é™…æ“ä½œ
    if ("claim".equals(request.getOperationType())) {
        relationshipService.createRelationship(patientId, doctorId);
    } else if ("release".equals(request.getOperationType())) {
        relationshipService.removeRelationship(patientId, doctorId);
    }
}
```

#### ConsultationService

**æ ¸å¿ƒæ–¹æ³•**ï¼š

| æ–¹æ³• | åŠŸèƒ½ | è¯´æ˜ |
|-----|------|------|
| `getOrCreateSession` | è·å–æˆ–åˆ›å»ºä¼šè¯ | æ™ºèƒ½å¤ç”¨ongoingä¼šè¯æˆ–åˆ›å»ºæ–°ä¼šè¯ |
| `getDoctorSessions` | è·å–åŒ»ç”Ÿçš„ä¼šè¯åˆ—è¡¨ | è¿”å›åŒ»ç”Ÿçš„æ‰€æœ‰å’¨è¯¢ä¼šè¯ |
| `getPatientSession` | è·å–æ‚£è€…çš„å½“å‰ä¼šè¯ | è¿”å›æ‚£è€…æ­£åœ¨è¿›è¡Œçš„ä¼šè¯ |
| `closeSession` | å…³é—­ä¼šè¯ | ç»“æŸå’¨è¯¢ä¼šè¯å¹¶è®°å½•ç»“æŸæ—¶é—´ |

### 4. Controllerå±‚

#### DoctorControllerï¼ˆåŒ»ç”Ÿç«¯ï¼‰

**æ‚£è€…å…¬æµ·ç›¸å…³æ¥å£**ï¼š

```java
// è·å–æ‚£è€…å…¬æµ·åˆ—è¡¨
@GetMapping("/patient-pool")
@PreAuthorize("hasRole('DOCTOR')")
public Result<IPage<Map<String, Object>>> getPatientPool(
    @RequestParam(defaultValue = "1") int pageNum,
    @RequestParam(defaultValue = "10") int pageSize,
    @RequestParam(required = false) String keyword)

// è®¤é¢†æ‚£è€…
@PostMapping("/patient-pool/claim/{patientId}")
@PreAuthorize("hasRole('DOCTOR')")
public Result<String> claimPatient(
    @PathVariable Long patientId,
    @RequestBody Map<String, String> request,
    @RequestHeader("Authorization") String token)
```

**æ‚£è€…ç®¡ç†ç›¸å…³æ¥å£**ï¼š

```java
// é‡Šæ”¾æ‚£è€…
@PostMapping("/patients/{patientId}/release")
@PreAuthorize("hasRole('DOCTOR')")
public Result<String> releasePatient(
    @PathVariable Long patientId,
    @RequestBody Map<String, String> request,
    @RequestHeader("Authorization") String token)

// æŸ¥çœ‹ç”³è¯·å†å²
@GetMapping("/requests")
@PreAuthorize("hasRole('DOCTOR')")
public Result<IPage<Map<String, Object>>> getDoctorRequests(...)
```

**åœ¨çº¿å’¨è¯¢ç›¸å…³æ¥å£**ï¼š

```java
// è·å–å’¨è¯¢ä¼šè¯åˆ—è¡¨
@GetMapping("/consultations")
@PreAuthorize("hasRole('DOCTOR')")
public Result<IPage<Map<String, Object>>> getConsultations(...)

// å…³é—­å’¨è¯¢ä¼šè¯
@PostMapping("/consultations/{sessionId}/close")
@PreAuthorize("hasRole('DOCTOR')")
public Result<String> closeConsultation(...)
```

#### AdminControllerï¼ˆç®¡ç†å‘˜ç«¯ï¼‰

**æ‚£è€…åˆ†é…å®¡æ ¸æ¥å£**ï¼š

```java
// è·å–å¾…å®¡æ ¸çš„æ‚£è€…åˆ†é…è¯·æ±‚
@GetMapping("/patient-assignments/pending")
@PreAuthorize("hasRole('ADMIN')")
public Result<IPage<Map<String, Object>>> getPendingAssignments(...)

// å®¡æ ¸é€šè¿‡
@PostMapping("/patient-assignments/{requestId}/approve")
@PreAuthorize("hasRole('ADMIN')")
public Result<String> approveAssignment(...)

// å®¡æ ¸æ‹’ç»
@PostMapping("/patient-assignments/{requestId}/reject")
@PreAuthorize("hasRole('ADMIN')")
public Result<String> rejectAssignment(...)
```

#### PatientControllerï¼ˆæ‚£è€…ç«¯ï¼‰

**åŒ»ç”ŸæŸ¥çœ‹ç›¸å…³æ¥å£**ï¼š

```java
// è·å–æˆ‘çš„åŒ»ç”Ÿ
@GetMapping("/my-doctor")
@PreAuthorize("hasRole('PATIENT')")
public Result<Map<String, Object>> getMyDoctor(
    @RequestHeader("Authorization") String token)

// è·å–æˆ‘çš„å’¨è¯¢ä¼šè¯
@GetMapping("/my-consultation")
@PreAuthorize("hasRole('PATIENT')")
public Result<Map<String, Object>> getMyConsultation(...)

// å‘èµ·å’¨è¯¢
@PostMapping("/consultation/start")
@PreAuthorize("hasRole('PATIENT')")
public Result<Map<String, Object>> startConsultation(...)
```

---

## ğŸ¨ å‰ç«¯å®ç°

### 1. APIæ¥å£å®šä¹‰

åœ¨ `frontend/src/api/index.ts` ä¸­æ·»åŠ äº†å®Œæ•´çš„APIæ¥å£å®šä¹‰ï¼š

#### åŒ»ç”Ÿç«¯API
```typescript
export const doctorApi = {
  // æ‚£è€…å…¬æµ·
  getPatientPool: (params: { pageNum: number; pageSize: number; keyword?: string }) =>
    request.get<any, ApiResponse<PageResult<any>>>('/doctor/patient-pool', { params }),

  claimPatient: (patientId: number, data: { reason: string }) =>
    request.post<any, ApiResponse<string>>(`/doctor/patient-pool/claim/${patientId}`, data),

  releasePatient: (patientId: number, data: { reason: string }) =>
    request.post<any, ApiResponse<string>>(`/doctor/patients/${patientId}/release`, data),

  // åœ¨çº¿å’¨è¯¢
  getConsultations: (params: { pageNum: number; pageSize: number; status?: string }) =>
    request.get<any, ApiResponse<PageResult<any>>>('/doctor/consultations', { params }),

  closeConsultation: (sessionId: number) =>
    request.post<any, ApiResponse<string>>(`/doctor/consultations/${sessionId}/close`)
}
```

#### ç®¡ç†å‘˜ç«¯API
```typescript
export const adminApi = {
  getPendingAssignments: (params: { pageNum: number; pageSize: number; requestType?: string }) =>
    request.get<any, ApiResponse<PageResult<any>>>('/admin/patient-assignments/pending', { params }),

  approveAssignment: (requestId: number, data?: { adminNote?: string }) =>
    request.post<any, ApiResponse<string>>(`/admin/patient-assignments/${requestId}/approve`, data || {}),

  rejectAssignment: (requestId: number, data: { adminNote: string }) =>
    request.post<any, ApiResponse<string>>(`/admin/patient-assignments/${requestId}/reject`, data)
}
```

#### æ‚£è€…ç«¯API
```typescript
export const userApi = {
  getMyDoctor: () =>
    request.get<any, ApiResponse<any>>('/patient/my-doctor'),

  getMyConsultation: () =>
    request.get<any, ApiResponse<any>>('/patient/my-consultation'),

  startConsultation: (data: { message: string }) =>
    request.post<any, ApiResponse<any>>('/patient/consultation/start', data)
}
```

### 2. åŒ»ç”Ÿç«¯é¡µé¢

#### PatientPool.vueï¼ˆæ‚£è€…å…¬æµ·ï¼‰

**åŠŸèƒ½ç‰¹æ€§**ï¼š
- å±•ç¤ºæœªåˆ†é…çš„æ‚£è€…åˆ—è¡¨
- æ”¯æŒå…³é”®è¯æœç´¢
- è®¤é¢†æ‚£è€…å¹¶å¡«å†™ç†ç”±
- åˆ†é¡µå±•ç¤º

**æ ¸å¿ƒåŠŸèƒ½ä»£ç **ï¼š
```typescript
const submitClaim = async () => {
  if (!claimForm.value.reason.trim()) {
    ElMessage.warning('è¯·è¾“å…¥è®¤é¢†ç†ç”±')
    return
  }

  try {
    const res = await doctorApi.claimPatient(currentPatient.value.id, {
      reason: claimForm.value.reason
    })
    if (res.code === 200) {
      ElMessage.success('è®¤é¢†ç”³è¯·å·²æäº¤ï¼Œè¯·ç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸')
      claimDialogVisible.value = false
      loadPatientPool()
    }
  } catch (error) {
    ElMessage.error('æäº¤è®¤é¢†ç”³è¯·å¤±è´¥')
  }
}
```

**é¡µé¢ä½ç½®**ï¼š`frontend/src/views/doctor/PatientPool.vue`

#### Consultation.vueï¼ˆåœ¨çº¿å’¨è¯¢ç®¡ç†ï¼‰

**åŠŸèƒ½ç‰¹æ€§**ï¼š
- æŸ¥çœ‹æ‰€æœ‰å’¨è¯¢ä¼šè¯åˆ—è¡¨
- æŒ‰çŠ¶æ€ç­›é€‰ï¼ˆè¿›è¡Œä¸­/å·²å…³é—­ï¼‰
- æ˜¾ç¤ºä¼šè¯æ—¶é•¿
- ç»“æŸå’¨è¯¢ä¼šè¯
- æŸ¥çœ‹ä¼šè¯è¯¦æƒ…

**æ ¸å¿ƒåŠŸèƒ½ä»£ç **ï¼š
```typescript
const closeConsultation = async () => {
  try {
    const res = await doctorApi.closeConsultation(currentSession.value.id)
    if (res.code === 200) {
      ElMessage.success('å’¨è¯¢ä¼šè¯å·²ç»“æŸ')
      closeDialogVisible.value = false
      loadConsultations()
    }
  } catch (error) {
    ElMessage.error('ç»“æŸå’¨è¯¢ä¼šè¯å¤±è´¥')
  }
}
```

**é¡µé¢ä½ç½®**ï¼š`frontend/src/views/doctor/Consultation.vue`

#### Patients.vueï¼ˆæ‚£è€…ç®¡ç† - æ›´æ–°ï¼‰

**æ–°å¢åŠŸèƒ½**ï¼š
- æ·»åŠ "é‡Šæ”¾"æŒ‰é’®
- é‡Šæ”¾æ‚£è€…å¯¹è¯æ¡†
- å¡«å†™é‡Šæ”¾ç†ç”±
- æäº¤é‡Šæ”¾ç”³è¯·

**æ ¸å¿ƒä»£ç **ï¼š
```typescript
const submitRelease = async () => {
  if (!releaseForm.value.reason.trim()) {
    ElMessage.warning('è¯·è¾“å…¥é‡Šæ”¾ç†ç”±')
    return
  }

  try {
    const res = await doctorApi.releasePatient(currentPatient.value.id, {
      reason: releaseForm.value.reason
    })
    if (res.code === 200) {
      ElMessage.success('é‡Šæ”¾ç”³è¯·å·²æäº¤ï¼Œè¯·ç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸')
      releaseDialogVisible.value = false
      loadPatients()
    }
  } catch (error) {
    ElMessage.error('æäº¤é‡Šæ”¾ç”³è¯·å¤±è´¥')
  }
}
```

**é¡µé¢ä½ç½®**ï¼š`frontend/src/views/doctor/Patients.vue:219-251`

### 3. ç®¡ç†å‘˜ç«¯é¡µé¢

#### Doctors.vueï¼ˆåŒ»ç”Ÿç®¡ç† - æ›´æ–°ï¼‰

**æ–°å¢åŠŸèƒ½**ï¼š
- æ·»åŠ "æ‚£è€…åˆ†é…å®¡æ ¸"æ ‡ç­¾é¡µ
- å±•ç¤ºå¾…å®¡æ ¸çš„è®¤é¢†/é‡Šæ”¾è¯·æ±‚åˆ—è¡¨
- æ˜¾ç¤ºè¯·æ±‚è¯¦æƒ…ï¼ˆåŒ»ç”Ÿã€æ‚£è€…ã€ç†ç”±ï¼‰
- å®¡æ ¸é€šè¿‡/æ‹’ç»æ“ä½œ

**æ ¸å¿ƒåŠŸèƒ½ä»£ç **ï¼š
```typescript
const handleApproveAssignment = async (request: any) => {
  try {
    await ElMessageBox.confirm(
      `ç¡®å®šé€šè¿‡æ­¤${request.operationType === 'claim' ? 'è®¤é¢†' : 'é‡Šæ”¾'}ç”³è¯·å—ï¼Ÿ`,
      'å®¡æ ¸é€šè¿‡',
      { confirmButtonText: 'ç¡®å®š', cancelButtonText: 'å–æ¶ˆ', type: 'success' }
    )

    const res = await adminApi.approveAssignment(request.id)
    if (res.code === 200) {
      ElMessage.success('å®¡æ ¸é€šè¿‡')
      fetchAssignmentRequests()
    }
  } catch (error) {
    if (error !== 'cancel') {
      ElMessage.error('å®¡æ ¸å¤±è´¥')
    }
  }
}
```

**é¡µé¢ä½ç½®**ï¼š`frontend/src/views/admin/Doctors.vue:43-47, 139-192`

### 4. æ‚£è€…ç«¯é¡µé¢

#### Communication.vueï¼ˆåŒ»æ‚£æ²Ÿé€š - æ›´æ–°ï¼‰

**æ–°å¢åŠŸèƒ½**ï¼š
- é¡¶éƒ¨æ˜¾ç¤º"æˆ‘çš„åŒ»ç”Ÿ"å¡ç‰‡
- å±•ç¤ºå·²åˆ†é…åŒ»ç”Ÿçš„è¯¦ç»†ä¿¡æ¯
- å¿«é€Ÿå¼€å§‹å’¨è¯¢æŒ‰é’®
- æœªåˆ†é…åŒ»ç”Ÿæ—¶æ˜¾ç¤ºæç¤º

**æ ¸å¿ƒåŠŸèƒ½ä»£ç **ï¼š
```typescript
const loadMyDoctor = async () => {
  myDoctorLoading.value = true
  try {
    const res = await userApi.getMyDoctor()
    if (res.code === 200 && res.data) {
      myDoctor.value = res.data
    }
  } catch (error) {
    console.log('No assigned doctor')
  } finally {
    myDoctorLoading.value = false
  }
}
```

**UIè®¾è®¡**ï¼š
```vue
<el-card class="my-doctor-card" v-loading="myDoctorLoading">
  <template #header>
    <span>ğŸ‘¨â€âš•ï¸ æˆ‘çš„åŒ»ç”Ÿ</span>
  </template>

  <div v-if="myDoctor" class="my-doctor-info">
    <el-avatar :src="myDoctor.avatar" :size="60" />
    <div class="doctor-details">
      <div class="doctor-name-main">{{ myDoctor.nickname }}</div>
      <div class="doctor-specialization">{{ myDoctor.specialization }}</div>
    </div>
    <el-button type="primary" @click="selectDoctor(myDoctor)">
      å¼€å§‹å’¨è¯¢
    </el-button>
  </div>

  <el-empty v-else description="æ‚¨è¿˜æ²¡æœ‰åˆ†é…çš„ä¸“å±åŒ»ç”Ÿ" />
</el-card>
```

**é¡µé¢ä½ç½®**ï¼š`frontend/src/views/patient/Communication.vue:8-32`

---

## ğŸ”„ ä¸šåŠ¡æµç¨‹

### 1. æ‚£è€…è®¤é¢†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åŒ»ç”Ÿæµè§ˆâ”‚      â”‚ æäº¤è®¤é¢†â”‚      â”‚ ç®¡ç†å‘˜  â”‚      â”‚ å…³ç³»å»ºç«‹â”‚
â”‚ æ‚£è€…å…¬æµ·â”‚  â†’   â”‚ ç”³è¯·    â”‚  â†’   â”‚ å®¡æ ¸    â”‚  â†’   â”‚ å®Œæˆ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“                â†“                â†“                â†“
æŸ¥çœ‹æœªåˆ†é…      å¡«å†™è®¤é¢†ç†ç”±      å®¡æ‰¹é€šè¿‡/æ‹’ç»    è‡ªåŠ¨åˆ›å»ºå…³ç³»
æ‚£è€…åˆ—è¡¨        æäº¤ç”³è¯·          è®°å½•å®¡æ‰¹æ„è§      æ‚£è€…å¯è§åŒ»ç”Ÿ
```

**è¯¦ç»†æ­¥éª¤**ï¼š

1. **åŒ»ç”Ÿç«¯æ“ä½œ**ï¼š
   - è¿›å…¥"æ‚£è€…å…¬æµ·"é¡µé¢
   - æµè§ˆæœªåˆ†é…çš„æ‚£è€…åˆ—è¡¨
   - ç‚¹å‡»"è®¤é¢†"æŒ‰é’®
   - å¡«å†™è®¤é¢†ç†ç”±ï¼ˆå¿…å¡«ï¼‰
   - æäº¤ç”³è¯· â†’ çŠ¶æ€ï¼špending

2. **ç³»ç»ŸéªŒè¯**ï¼š
   - æ£€æŸ¥åŒ»ç”Ÿæ‚£è€…æ•°é‡æ˜¯å¦ < 10
   - æ£€æŸ¥æ‚£è€…æ˜¯å¦å·²è¢«åˆ†é…
   - éªŒè¯é€šè¿‡ååˆ›å»ºè¯·æ±‚è®°å½•

3. **ç®¡ç†å‘˜å®¡æ ¸**ï¼š
   - è¿›å…¥"åŒ»ç”Ÿç®¡ç†" â†’ "æ‚£è€…åˆ†é…å®¡æ ¸"æ ‡ç­¾é¡µ
   - æŸ¥çœ‹å¾…å®¡æ ¸çš„è®¤é¢†ç”³è¯·
   - æŸ¥çœ‹åŒ»ç”Ÿä¿¡æ¯ã€æ‚£è€…ä¿¡æ¯ã€è®¤é¢†ç†ç”±
   - é€‰æ‹©"é€šè¿‡"æˆ–"æ‹’ç»"

4. **å®¡æ ¸é€šè¿‡**ï¼š
   - æ›´æ–°è¯·æ±‚çŠ¶æ€ä¸º approved
   - è‡ªåŠ¨è°ƒç”¨ `createRelationship()`
   - åœ¨ patient_doctor_relationship è¡¨ä¸­åˆ›å»ºè®°å½•
   - æ‚£è€…åœ¨"åŒ»æ‚£æ²Ÿé€š"é¡µé¢å¯çœ‹åˆ°åˆ†é…çš„åŒ»ç”Ÿ

5. **å®¡æ ¸æ‹’ç»**ï¼š
   - æ›´æ–°è¯·æ±‚çŠ¶æ€ä¸º rejected
   - è®°å½•ç®¡ç†å‘˜æ‹’ç»ç†ç”±
   - åŒ»ç”Ÿå¯åœ¨"ç”³è¯·å†å²"ä¸­æŸ¥çœ‹æ‹’ç»åŸå› 

### 2. æ‚£è€…é‡Šæ”¾æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åŒ»ç”Ÿé€‰æ‹©â”‚      â”‚ æäº¤é‡Šæ”¾â”‚      â”‚ ç®¡ç†å‘˜  â”‚      â”‚ å…³ç³»è§£é™¤â”‚
â”‚ æ‚£è€…é‡Šæ”¾â”‚  â†’   â”‚ ç”³è¯·    â”‚  â†’   â”‚ å®¡æ ¸    â”‚  â†’   â”‚ å®Œæˆ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“                â†“                â†“                â†“
åœ¨æ‚£è€…ç®¡ç†      å¡«å†™é‡Šæ”¾ç†ç”±      å®¡æ‰¹é€šè¿‡/æ‹’ç»    çŠ¶æ€è®¾ä¸ºinactive
é¡µé¢æ“ä½œ        æäº¤ç”³è¯·          è®°å½•å®¡æ‰¹æ„è§      æ‚£è€…å›åˆ°å…¬æµ·
```

**è¯¦ç»†æ­¥éª¤**ï¼š

1. **åŒ»ç”Ÿç«¯æ“ä½œ**ï¼š
   - è¿›å…¥"æ‚£è€…ç®¡ç†"é¡µé¢
   - åœ¨æ‚£è€…åˆ—è¡¨ä¸­æ‰¾åˆ°è¦é‡Šæ”¾çš„æ‚£è€…
   - ç‚¹å‡»"é‡Šæ”¾"æŒ‰é’®
   - å¡«å†™é‡Šæ”¾ç†ç”±ï¼ˆå¿…å¡«ï¼‰
   - æäº¤ç”³è¯· â†’ çŠ¶æ€ï¼špending

2. **ç³»ç»ŸéªŒè¯**ï¼š
   - éªŒè¯åŒ»æ‚£å…³ç³»ç¡®å®å­˜åœ¨
   - éªŒè¯å…³ç³»çŠ¶æ€ä¸º active
   - éªŒè¯é€šè¿‡ååˆ›å»ºè¯·æ±‚è®°å½•

3. **ç®¡ç†å‘˜å®¡æ ¸**ï¼š
   - åœ¨"æ‚£è€…åˆ†é…å®¡æ ¸"æ ‡ç­¾é¡µæŸ¥çœ‹
   - æŸ¥çœ‹é‡Šæ”¾ç”³è¯·è¯¦æƒ…
   - é€‰æ‹©"é€šè¿‡"æˆ–"æ‹’ç»"

4. **å®¡æ ¸é€šè¿‡**ï¼š
   - æ›´æ–°è¯·æ±‚çŠ¶æ€ä¸º approved
   - è‡ªåŠ¨è°ƒç”¨ `removeRelationship()`
   - å°†å…³ç³»çŠ¶æ€è®¾ç½®ä¸º inactive
   - æ‚£è€…é‡æ–°è¿›å…¥æ‚£è€…å…¬æµ·

5. **å®¡æ ¸æ‹’ç»**ï¼š
   - æ›´æ–°è¯·æ±‚çŠ¶æ€ä¸º rejected
   - è®°å½•æ‹’ç»ç†ç”±
   - åŒ»æ‚£å…³ç³»ä¿æŒä¸å˜

### 3. åœ¨çº¿å’¨è¯¢æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ‚£è€…å‘èµ·â”‚      â”‚ åˆ›å»ºä¼šè¯â”‚      â”‚ åŒ»ç”Ÿç®¡ç†â”‚      â”‚ ç»“æŸä¼šè¯â”‚
â”‚ å’¨è¯¢    â”‚  â†’   â”‚         â”‚  â†’   â”‚ å’¨è¯¢    â”‚  â†’   â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“                â†“                â†“                â†“
é€‰æ‹©åŒ»ç”Ÿ        è‡ªåŠ¨åˆ›å»ºæˆ–       æŸ¥çœ‹ä¼šè¯åˆ—è¡¨      å…³é—­ä¼šè¯
å¼€å§‹å’¨è¯¢        å¤ç”¨ongoingä¼šè¯   ç›‘æ§ä¼šè¯çŠ¶æ€      è®°å½•ç»“æŸæ—¶é—´
```

**è¯¦ç»†æ­¥éª¤**ï¼š

1. **æ‚£è€…ç«¯æ“ä½œ**ï¼š
   - åœ¨"åŒ»æ‚£æ²Ÿé€š"é¡µé¢æŸ¥çœ‹"æˆ‘çš„åŒ»ç”Ÿ"
   - ç‚¹å‡»"å¼€å§‹å’¨è¯¢"æŒ‰é’®
   - ç³»ç»Ÿè°ƒç”¨ `startConsultation()`

2. **ä¼šè¯åˆ›å»º**ï¼š
   - è°ƒç”¨ `getOrCreateSession()`
   - å¦‚æœå­˜åœ¨ ongoing ä¼šè¯ï¼Œç›´æ¥è¿”å›
   - å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°çš„ä¼šè¯è®°å½•
   - çŠ¶æ€è®¾ç½®ä¸º ongoing

3. **åŒ»ç”Ÿç«¯ç®¡ç†**ï¼š
   - è¿›å…¥"åœ¨çº¿å’¨è¯¢ç®¡ç†"é¡µé¢
   - æŸ¥çœ‹æ‰€æœ‰å’¨è¯¢ä¼šè¯åˆ—è¡¨
   - å¯æŒ‰çŠ¶æ€ç­›é€‰ï¼ˆè¿›è¡Œä¸­/å·²å…³é—­ï¼‰
   - æŸ¥çœ‹ä¼šè¯æ—¶é•¿ç»Ÿè®¡

4. **ç»“æŸä¼šè¯**ï¼š
   - åŒ»ç”Ÿç‚¹å‡»"ç»“æŸå’¨è¯¢"æŒ‰é’®
   - ç¡®è®¤ç»“æŸæ“ä½œ
   - çŠ¶æ€æ›´æ–°ä¸º closed
   - è®°å½• end_time
   - è®¡ç®—ä¼šè¯æ€»æ—¶é•¿

---

## ğŸ“± ä½¿ç”¨è¯´æ˜

### åŒ»ç”Ÿç«¯ä½¿ç”¨æŒ‡å—

#### 1. è®¤é¢†æ‚£è€…

1. ç™»å½•åŒ»ç”Ÿè´¦å·
2. å¯¼èˆªè‡³"æ‚£è€…å…¬æµ·"é¡µé¢
3. æµè§ˆæœªåˆ†é…çš„æ‚£è€…åˆ—è¡¨
4. ç‚¹å‡»ç›®æ ‡æ‚£è€…çš„"è®¤é¢†"æŒ‰é’®
5. åœ¨å¼¹å‡ºçš„å¯¹è¯æ¡†ä¸­å¡«å†™è®¤é¢†ç†ç”±
6. ç‚¹å‡»"æäº¤è®¤é¢†ç”³è¯·"
7. ç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸é€šçŸ¥

#### 2. ç®¡ç†æ‚£è€…

1. å¯¼èˆªè‡³"æ‚£è€…ç®¡ç†"é¡µé¢
2. æŸ¥çœ‹å½“å‰ç®¡ç†çš„æ‰€æœ‰æ‚£è€…
3. å¯ä»¥ï¼š
   - ç‚¹å‡»"è¯¦æƒ…"æŸ¥çœ‹æ‚£è€…å®Œæ•´ä¿¡æ¯
   - ç‚¹å‡»"æ²Ÿé€š"è¿›å…¥èŠå¤©ç•Œé¢
   - ç‚¹å‡»"é‡Šæ”¾"ç”³è¯·è§£é™¤åŒ»æ‚£å…³ç³»

#### 3. é‡Šæ”¾æ‚£è€…

1. åœ¨æ‚£è€…ç®¡ç†é¡µé¢æ‰¾åˆ°è¦é‡Šæ”¾çš„æ‚£è€…
2. ç‚¹å‡»"é‡Šæ”¾"æŒ‰é’®
3. å¡«å†™é‡Šæ”¾ç†ç”±ï¼ˆå¦‚ï¼šæ‚£è€…åº·å¤ã€è½¬è¯Šç­‰ï¼‰
4. æäº¤ç”³è¯·ç­‰å¾…å®¡æ ¸

#### 4. ç®¡ç†å’¨è¯¢ä¼šè¯

1. å¯¼èˆªè‡³"åœ¨çº¿å’¨è¯¢ç®¡ç†"é¡µé¢
2. æŸ¥çœ‹æ‰€æœ‰å’¨è¯¢ä¼šè¯
3. å¯ç­›é€‰"è¿›è¡Œä¸­"æˆ–"å·²å…³é—­"çš„ä¼šè¯
4. ç‚¹å‡»"ç»“æŸå’¨è¯¢"å…³é—­ä¼šè¯
5. ç‚¹å‡»"æŸ¥çœ‹è¯¦æƒ…"æŸ¥çœ‹ä¼šè¯ä¿¡æ¯

### ç®¡ç†å‘˜ç«¯ä½¿ç”¨æŒ‡å—

#### 1. å®¡æ ¸æ‚£è€…åˆ†é…

1. ç™»å½•ç®¡ç†å‘˜è´¦å·
2. å¯¼èˆªè‡³"åŒ»ç”Ÿç®¡ç†"é¡µé¢
3. ç‚¹å‡»"æ‚£è€…åˆ†é…å®¡æ ¸"æ ‡ç­¾é¡µ
4. æŸ¥çœ‹å¾…å®¡æ ¸çš„ç”³è¯·åˆ—è¡¨ï¼ŒåŒ…æ‹¬ï¼š
   - è®¤é¢†ç”³è¯·ï¼ˆç»¿è‰²æ ‡ç­¾ï¼‰
   - é‡Šæ”¾ç”³è¯·ï¼ˆé»„è‰²æ ‡ç­¾ï¼‰

#### 2. å®¡æ ¸é€šè¿‡

1. æŸ¥çœ‹ç”³è¯·è¯¦æƒ…ï¼š
   - åŒ»ç”Ÿå§“åå’ŒID
   - æ‚£è€…å§“åå’ŒID
   - ç”³è¯·ç†ç”±
   - ç”³è¯·æ—¶é—´
2. ç‚¹å‡»"âœ… é€šè¿‡"æŒ‰é’®
3. ç¡®è®¤æ“ä½œ
4. ç³»ç»Ÿè‡ªåŠ¨æ‰§è¡Œå…³ç³»å˜æ›´

#### 3. å®¡æ ¸æ‹’ç»

1. ç‚¹å‡»"âŒ æ‹’ç»"æŒ‰é’®
2. åœ¨å¼¹å‡ºçš„å¯¹è¯æ¡†ä¸­è¾“å…¥æ‹’ç»ç†ç”±
3. ç¡®è®¤æ‹’ç»
4. ç³»ç»Ÿè®°å½•æ‹’ç»åŸå› å¹¶é€šçŸ¥åŒ»ç”Ÿ

### æ‚£è€…ç«¯ä½¿ç”¨æŒ‡å—

#### 1. æŸ¥çœ‹æˆ‘çš„åŒ»ç”Ÿ

1. ç™»å½•æ‚£è€…è´¦å·
2. å¯¼èˆªè‡³"åŒ»æ‚£æ²Ÿé€š"é¡µé¢
3. é¡¶éƒ¨çš„"æˆ‘çš„åŒ»ç”Ÿ"å¡ç‰‡æ˜¾ç¤ºï¼š
   - åŒ»ç”Ÿå¤´åƒ
   - åŒ»ç”Ÿå§“å
   - ä¸“ä¸šé¢†åŸŸ
   - è”ç³»æ–¹å¼

#### 2. å‘èµ·å’¨è¯¢

1. åœ¨"æˆ‘çš„åŒ»ç”Ÿ"å¡ç‰‡ä¸­ç‚¹å‡»"å¼€å§‹å’¨è¯¢"
2. ç³»ç»Ÿè‡ªåŠ¨åˆ›å»ºæˆ–å¤ç”¨å’¨è¯¢ä¼šè¯
3. è¿›å…¥èŠå¤©ç•Œé¢ä¸åŒ»ç”Ÿæ²Ÿé€š

---

## âš™ï¸ é…ç½®ä¸éƒ¨ç½²

### 1. æ•°æ®åº“åˆå§‹åŒ–

æ‰§è¡ŒSQLæ–‡ä»¶åˆ›å»ºæ•°æ®è¡¨ï¼š

```bash
# ä½¿ç”¨MySQLå®¢æˆ·ç«¯æ‰§è¡Œ
mysql -u root -p mental_health < patient_doctor_relationship_tables.sql
```

æˆ–åœ¨MySQL Workbenchä¸­ï¼š
1. æ‰“å¼€SQLæ–‡ä»¶ï¼š`patient_doctor_relationship_tables.sql`
2. é€‰æ‹©æ•°æ®åº“ï¼š`mental_health`
3. æ‰§è¡Œè„šæœ¬

### 2. åˆå§‹åŒ–æµ‹è¯•æ•°æ®

SQLæ–‡ä»¶å·²åŒ…å«æµ‹è¯•æ•°æ®ï¼š
- åŒ»ç”Ÿ 'ooo' (user_id=7)
- æ‚£è€… 'æ‚£è€…1' (user_id=9)
- å»ºç«‹åŒ»æ‚£å…³ç³»

### 3. åç«¯é…ç½®

ç¡®ä¿ `application.yml` é…ç½®æ­£ç¡®ï¼š

```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/mental_health?useUnicode=true&characterEncoding=utf-8
    username: root
    password: your_password

mybatis-plus:
  configuration:
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
  global-config:
    db-config:
      logic-delete-field: deleted
      logic-delete-value: 1
      logic-not-delete-value: 0
```

### 4. å¯åŠ¨é¡¹ç›®

**åç«¯å¯åŠ¨**ï¼š
```bash
cd E:\ddd\æ™ºèƒ½å¿ƒé‡Œå¥åº·ç®¡ç†ç³»ç»Ÿ
mvn spring-boot:run
```

**å‰ç«¯å¯åŠ¨**ï¼š
```bash
cd E:\ddd\æ™ºèƒ½å¿ƒé‡Œå¥åº·ç®¡ç†ç³»ç»Ÿ\frontend
npm run dev
```

### 5. è®¿é—®åœ°å€

- å‰ç«¯ï¼š`http://localhost:5173`
- åç«¯ï¼š`http://localhost:8080`
- APIæ–‡æ¡£ï¼š`http://localhost:8080/swagger-ui.html` (å¦‚å·²é…ç½®)

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ä¸šåŠ¡è§„åˆ™

- **åŒ»ç”Ÿæ‚£è€…é™åˆ¶**ï¼šæ¯ä¸ªåŒ»ç”Ÿæœ€å¤šç®¡ç†10ä¸ªæ‚£è€…ï¼Œè¶…è¿‡é™åˆ¶æ— æ³•è®¤é¢†
- **æ‚£è€…å”¯ä¸€åŒ»ç”Ÿ**ï¼šæ¯ä¸ªæ‚£è€…åªèƒ½åˆ†é…ç»™ä¸€ä¸ªåŒ»ç”Ÿï¼Œé€šè¿‡æ•°æ®åº“å”¯ä¸€çº¦æŸä¿è¯
- **å®¡æ‰¹å¿…éœ€**ï¼šæ‰€æœ‰è®¤é¢†å’Œé‡Šæ”¾æ“ä½œéƒ½å¿…é¡»ç»è¿‡ç®¡ç†å‘˜å®¡æ ¸
- **ä¼šè¯å¤ç”¨**ï¼šæ‚£è€…å‘èµ·å’¨è¯¢æ—¶ï¼Œå¦‚æœå­˜åœ¨è¿›è¡Œä¸­çš„ä¼šè¯ï¼Œä¼šè‡ªåŠ¨å¤ç”¨

### 2. æ•°æ®ä¸€è‡´æ€§

- ä½¿ç”¨ `@Transactional` ç¡®ä¿å®¡æ‰¹æ“ä½œçš„åŸå­æ€§
- é€»è¾‘åˆ é™¤ï¼ˆsoft deleteï¼‰ä¿ç•™å†å²è®°å½•
- å”¯ä¸€ç´¢å¼•é˜²æ­¢æ•°æ®å†²çª

### 3. æƒé™æ§åˆ¶

- æ‰€æœ‰æ¥å£éƒ½ä½¿ç”¨ `@PreAuthorize` è¿›è¡Œè§’è‰²éªŒè¯
- JWT token å¿…é¡»åœ¨è¯·æ±‚å¤´ä¸­æºå¸¦
- è·¨ç«¯æ“ä½œï¼ˆå¦‚åŒ»ç”Ÿæ“ä½œæ‚£è€…ç«¯æ¥å£ï¼‰ä¼šè¢«æ‹’ç»

### 4. é”™è¯¯å¤„ç†

ç³»ç»Ÿä¼šè¿”å›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯ï¼š
- `åŒ»ç”Ÿå·²è¾¾åˆ°æœ€å¤§æ‚£è€…æ•°é‡é™åˆ¶` - åŒ»ç”Ÿæ‚£è€…æ•° >= 10
- `è¯¥æ‚£è€…å·²è¢«å…¶ä»–åŒ»ç”Ÿè®¤é¢†` - æ‚£è€…å·²æœ‰æ´»è·ƒåŒ»ç”Ÿ
- `åŒ»æ‚£å…³ç³»ä¸å­˜åœ¨` - é‡Šæ”¾æ“ä½œæ—¶å…³ç³»ä¸å­˜åœ¨
- `æƒé™ä¸è¶³` - è§’è‰²éªŒè¯å¤±è´¥

### 5. æ€§èƒ½ä¼˜åŒ–å»ºè®®

- æ‚£è€…å…¬æµ·æŸ¥è¯¢æ·»åŠ äº†åˆ†é¡µï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½å¤§é‡æ•°æ®
- ä½¿ç”¨ `Map` è¿”å›è”è¡¨æŸ¥è¯¢ç»“æœï¼Œå‡å°‘ç½‘ç»œä¼ è¾“
- å‰ç«¯åˆ—è¡¨ç»„ä»¶ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨ï¼ˆå¦‚æ•°æ®é‡å¤§ï¼‰
- è€ƒè™‘æ·»åŠ  Redis ç¼“å­˜é¢‘ç¹æŸ¥è¯¢çš„æ•°æ®

### 6. å®‰å…¨æ€§è€ƒè™‘

- æ‰€æœ‰ç”¨æˆ·è¾“å…¥éƒ½éœ€è¦åœ¨å‰ç«¯å’Œåç«¯åŒé‡éªŒè¯
- ç”³è¯·ç†ç”±å­—æ®µæœ‰é•¿åº¦é™åˆ¶ï¼ˆ500å­—ç¬¦ï¼‰
- é˜²æ­¢ SQL æ³¨å…¥ï¼šä½¿ç”¨ MyBatis-Plus çš„å‚æ•°åŒ–æŸ¥è¯¢
- é˜²æ­¢ XSSï¼šå‰ç«¯ä½¿ç”¨ Element Plus é»˜è®¤è½¬ä¹‰

---

## ğŸ” æµ‹è¯•å»ºè®®

### 1. å•å…ƒæµ‹è¯•

æµ‹è¯•Serviceå±‚çš„æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼š

```java
@SpringBootTest
public class PatientDoctorRelationshipServiceTest {

    @Test
    public void testCheckDoctorPatientLimit() {
        // æµ‹è¯•åŒ»ç”Ÿæ‚£è€…æ•°é‡é™åˆ¶
    }

    @Test
    public void testCreateRelationship() {
        // æµ‹è¯•åˆ›å»ºåŒ»æ‚£å…³ç³»
    }
}
```

### 2. é›†æˆæµ‹è¯•

æµ‹è¯•å®Œæ•´çš„ä¸šåŠ¡æµç¨‹ï¼š

1. **è®¤é¢†æµç¨‹æµ‹è¯•**ï¼š
   - åŒ»ç”Ÿæäº¤è®¤é¢†ç”³è¯·
   - ç®¡ç†å‘˜å®¡æ ¸é€šè¿‡
   - éªŒè¯å…³ç³»å·²åˆ›å»º

2. **é‡Šæ”¾æµç¨‹æµ‹è¯•**ï¼š
   - åŒ»ç”Ÿæäº¤é‡Šæ”¾ç”³è¯·
   - ç®¡ç†å‘˜å®¡æ ¸é€šè¿‡
   - éªŒè¯å…³ç³»å·²è§£é™¤

3. **è¾¹ç•Œæ¡ä»¶æµ‹è¯•**ï¼š
   - åŒ»ç”Ÿè®¤é¢†ç¬¬10ä¸ªæ‚£è€…ï¼ˆåº”æˆåŠŸï¼‰
   - åŒ»ç”Ÿè®¤é¢†ç¬¬11ä¸ªæ‚£è€…ï¼ˆåº”å¤±è´¥ï¼‰
   - æ‚£è€…è¢«åˆ†é…åå†æ¬¡è¢«è®¤é¢†ï¼ˆåº”å¤±è´¥ï¼‰

### 3. å‰ç«¯æµ‹è¯•

ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼š

1. æ£€æŸ¥APIè¯·æ±‚æ˜¯å¦æ­£ç¡®
2. éªŒè¯é”™è¯¯æç¤ºæ˜¯å¦å‹å¥½
3. æµ‹è¯•åˆ†é¡µã€æœç´¢ç­‰åŠŸèƒ½
4. éªŒè¯æƒé™æ§åˆ¶æ˜¯å¦ç”Ÿæ•ˆ

---

## ğŸ“Š æ•°æ®ç»Ÿè®¡

ç³»ç»Ÿæä¾›ä»¥ä¸‹ç»Ÿè®¡åŠŸèƒ½ï¼ˆå¯æ‰©å±•ï¼‰ï¼š

1. **åŒ»ç”Ÿç»Ÿè®¡**ï¼š
   - ç®¡ç†æ‚£è€…æ•°é‡
   - å’¨è¯¢ä¼šè¯æ•°é‡
   - å¹³å‡ä¼šè¯æ—¶é•¿

2. **æ‚£è€…ç»Ÿè®¡**ï¼š
   - æ˜¯å¦å·²åˆ†é…åŒ»ç”Ÿ
   - å’¨è¯¢æ¬¡æ•°
   - æœ€è¿‘å’¨è¯¢æ—¶é—´

3. **ç®¡ç†å‘˜ç»Ÿè®¡**ï¼š
   - å¾…å®¡æ ¸ç”³è¯·æ•°é‡
   - å®¡æ ¸é€šè¿‡ç‡
   - è®¤é¢†/é‡Šæ”¾æ¯”ä¾‹

---

## ğŸš€ æ‰©å±•å»ºè®®

### 1. åŠŸèƒ½æ‰©å±•

- **æ‚£è€…è¯„ä»·ç³»ç»Ÿ**ï¼šæ‚£è€…å¯ä»¥å¯¹åŒ»ç”Ÿè¿›è¡Œè¯„åˆ†å’Œè¯„ä»·
- **åŒ»ç”Ÿæ’ç­ç³»ç»Ÿ**ï¼šåŒ»ç”Ÿè®¾ç½®å¯å’¨è¯¢æ—¶é—´æ®µ
- **æ¶ˆæ¯æ¨é€**ï¼šå®¡æ ¸ç»“æœã€å’¨è¯¢æ¶ˆæ¯çš„å®æ—¶é€šçŸ¥
- **ä¼šè¯è®°å½•**ï¼šä¿å­˜å’¨è¯¢å¯¹è¯å†…å®¹
- **æ•°æ®å¯¼å‡º**ï¼šå¯¼å‡ºåŒ»æ‚£å…³ç³»æŠ¥è¡¨ã€å’¨è¯¢è®°å½•ç­‰

### 2. æŠ€æœ¯ä¼˜åŒ–

- **WebSocketé›†æˆ**ï¼šå®ç°å®æ—¶èŠå¤©åŠŸèƒ½
- **Redisç¼“å­˜**ï¼šç¼“å­˜æ‚£è€…å…¬æµ·åˆ—è¡¨ã€åŒ»ç”Ÿä¿¡æ¯ç­‰
- **Elasticsearch**ï¼šå…¨æ–‡æœç´¢æ‚£è€…ã€åŒ»ç”Ÿä¿¡æ¯
- **æ¶ˆæ¯é˜Ÿåˆ—**ï¼šå¼‚æ­¥å¤„ç†å®¡æ‰¹é€šçŸ¥
- **å¾®æœåŠ¡æ‹†åˆ†**ï¼šå°†åŒ»æ‚£å…³ç³»æ¨¡å—ç‹¬ç«‹æˆå¾®æœåŠ¡

### 3. ç”¨æˆ·ä½“éªŒä¼˜åŒ–

- **ç§»åŠ¨ç«¯é€‚é…**ï¼šå“åº”å¼è®¾è®¡æˆ–å¼€å‘ç§»åŠ¨App
- **æ™ºèƒ½æ¨è**ï¼šæ ¹æ®æ‚£è€…ç—‡çŠ¶æ¨èåˆé€‚çš„åŒ»ç”Ÿ
- **å¿«é€Ÿè®¤é¢†**ï¼šæ‰¹é‡è®¤é¢†æ‚£è€…åŠŸèƒ½
- **å®¡æ‰¹æ‰¹é‡æ“ä½œ**ï¼šç®¡ç†å‘˜æ‰¹é‡å®¡æ ¸
- **æ•°æ®å¯è§†åŒ–**ï¼šå›¾è¡¨å±•ç¤ºç»Ÿè®¡æ•°æ®

---

## ğŸ“ ç»´æŠ¤è¯´æ˜

### 1. æ—¥å¿—è®°å½•

å»ºè®®åœ¨å…³é”®æ“ä½œå¤„æ·»åŠ æ—¥å¿—ï¼š

```java
@Slf4j
@Service
public class RelationshipChangeRequestService {

    @Transactional
    public void approveRequest(Long requestId, Long adminId) {
        log.info("ç®¡ç†å‘˜ {} å®¡æ ¸è¯·æ±‚ {}", adminId, requestId);
        // ... ä¸šåŠ¡é€»è¾‘
        log.info("å®¡æ ¸å®Œæˆï¼Œæ“ä½œç±»å‹: {}", request.getOperationType());
    }
}
```

### 2. æ•°æ®å¤‡ä»½

å®šæœŸå¤‡ä»½ä»¥ä¸‹å…³é”®è¡¨ï¼š
- `patient_doctor_relationship`
- `relationship_change_request`
- `consultation_session`

### 3. ç›‘æ§æŒ‡æ ‡

å»ºè®®ç›‘æ§ï¼š
- è®¤é¢†è¯·æ±‚çš„å¤„ç†æ—¶é•¿
- å®¡æ ¸é€šè¿‡ç‡
- ç³»ç»Ÿä¸­æ´»è·ƒåŒ»æ‚£å…³ç³»æ•°é‡
- å’¨è¯¢ä¼šè¯å¹³å‡æ—¶é•¿

---

## ğŸ“ è”ç³»ä¸æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
**æœ€åæ›´æ–°**ï¼š2025-01-16
**ä½œè€…**ï¼šClaude Code Assistant
